<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator PWA</title>
    
    <!-- Minimal PWA Manifest - Guaranteed to work -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        
        input, button, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover {
            background: #218838;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .install-btn {
            background: #007bff;
            margin-top: 20px;
        }
        
        .install-btn:hover {
            background: #0056b3;
        }
        
        #installSection {
            margin-top: 30px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Calculator PWA</h1>
        
        <!-- PWA Status -->
        <div id="pwaStatus">
            <div class="status warning">üîÑ Checking PWA status...</div>
        </div>
        
        <!-- Simple Calculator -->
        <div>
            <input type="number" id="num1" placeholder="First number">
            <select id="operation">
                <option value="+">Addition (+)</option>
                <option value="-">Subtraction (-)</option>
                <option value="*">Multiplication (√ó)</option>
                <option value="/">Division (√∑)</option>
            </select>
            <input type="number" id="num2" placeholder="Second number">
            <button onclick="calculate()">Calculate</button>
            <div id="result"></div>
        </div>
        
        <!-- Install Section -->
        <div id="installSection">
            <div id="installStatus">üîç Looking for install option...</div>
            <button id="installBtn" onclick="installApp()" style="display:none;" class="install-btn">
                üì± Install App
            </button>
        </div>
    </div>

    <script>
        let deferredPrompt = null;
        let installChecks = 0;
        
        // Calculator function
        function calculate() {
            const num1 = parseFloat(document.getElementById('num1').value);
            const num2 = parseFloat(document.getElementById('num2').value);
            const operation = document.getElementById('operation').value;
            const resultDiv = document.getElementById('result');
            
            if (isNaN(num1) || isNaN(num2)) {
                resultDiv.innerHTML = '<div class="result" style="border-left-color: #dc3545;">Please enter valid numbers</div>';
                return;
            }
            
            let result;
            switch(operation) {
                case '+': result = num1 + num2; break;
                case '-': result = num1 - num2; break;
                case '*': result = num1 * num2; break;
                case '/': 
                    if (num2 === 0) {
                        resultDiv.innerHTML = '<div class="result" style="border-left-color: #dc3545;">Cannot divide by zero</div>';
                        return;
                    }
                    result = num1 / num2; 
                    break;
            }
            
            resultDiv.innerHTML = `<div class="result">${num1} ${operation} ${num2} = ${result}</div>`;
        }
        
        // PWA Status Check
        function updatePWAStatus() {
            const statusDiv = document.getElementById('pwaStatus');
            let status = [];
            
            // Check HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                status.push('<div class="status success">‚úÖ HTTPS: Secure</div>');
            } else {
                status.push('<div class="status error">‚ùå HTTPS: Required</div>');
            }
            
            // Check Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        status.push('<div class="status success">‚úÖ Service Worker: Active</div>');
                    } else {
                        status.push('<div class="status warning">‚ö†Ô∏è Service Worker: Registering...</div>');
                    }
                    statusDiv.innerHTML = status.join('');
                });
            } else {
                status.push('<div class="status error">‚ùå Service Worker: Not supported</div>');
            }
            
            // Check beforeinstallprompt
            if (deferredPrompt) {
                status.push('<div class="status success">‚úÖ Install Prompt: Ready!</div>');
                document.getElementById('installBtn').style.display = 'block';
                document.getElementById('installStatus').innerHTML = 'üéâ Ready to install!';
            } else {
                status.push('<div class="status warning">‚è≥ Install Prompt: Waiting...</div>');
            }
            
            statusDiv.innerHTML = status.join('');
        }
        
        // Install App Function
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('Install result:', choiceResult.outcome);
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('installStatus').innerHTML = '‚úÖ App installed successfully!';
                    } else {
                        document.getElementById('installStatus').innerHTML = '‚ùå Installation cancelled';
                    }
                    deferredPrompt = null;
                    updatePWAStatus();
                });
            }
        }
        
        // Listen for beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéâ beforeinstallprompt fired!');
            e.preventDefault();
            deferredPrompt = e;
            updatePWAStatus();
        });
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'calc-pwa-v1';
                const urlsToCache = ['./'];
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', event => {
                    event.waitUntil(self.clients.claim());
                });
                
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => response || fetch(event.request))
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('‚úÖ SW registered');
                    updatePWAStatus();
                })
                .catch(error => {
                    console.log('‚ùå SW failed:', error);
                    updatePWAStatus();
                });
        }
        
        // Check install status periodically
        function checkInstallStatus() {
            installChecks++;
            updatePWAStatus();
            
            if (installChecks < 20 && !deferredPrompt) {
                setTimeout(checkInstallStatus, 2000);
            } else if (!deferredPrompt) {
                document.getElementById('installStatus').innerHTML = `
                    ‚ùå Install prompt not triggered<br>
                    <small>Try: Chrome menu ‚Üí "Add to Home Screen"</small>
                `;
            }
        }
        
        // Start checking
        setTimeout(checkInstallStatus, 1000);
    </script>
</body>
</html>
